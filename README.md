# PreQL

* Author: Jonathan M. Wilbur <[jonathan@wilbur.space](mailto:jonathan@wilbur.space)>
* Copyright Year: 2019
* License: [MIT License](https://mit-license.org/)

## What is PreQL?

A Pre-SQL language that can transpile to any SQL dialect. It takes a declarative
Kubernetes-like YAML schema and generates the necessary commands or statements
in the correct order to generate schema and other database objects in the
database dialect of your choice.

## What is this Library

This library converts PreQL into OpenLDAP OLC Schema.

## Limitations

Because of limitations of LDAP--not PreQL--this library cannot do the following:

- Check that an entry already exists before attempting to insert.
- Know the name of your database when applying indexes.
  - This is because, in OpenLDAP, the database is named after the driver,
    rather than the suffix or any other characteristic the user has
    control over. As an example, if MDB is used as the storage backend,
    a database entry `olcDatabase={#}mdb,cn=config` will exist, where `#`
    is a number. This number is generated by the server, and, therefore,
    cannot be known during transpilation.
- Know the suffix to which you want to apply entries.
  - Technically, I could use a `label` or allow the `suffix` to be explicitly
    stated in each `Entry`'s `spec`, but this seems like a bad solution,
    because there is no good way to ensure that the suffix components exist
    in the first place.

## Notes

- The Syntax OID and length comes from the `DataType`
  - If the `DataType` lacks these, the `jsonEquivalent` field is used to map it to the most sensible type:
    - A `boolean` becomes a `BOOLEAN`
    - An `integer` becomes an `INTEGER`
    - A `number` becomes a `PrintableString` (OpenLDAP does not provide any `REAL` type)
    - A `string` becomes a `directoryString`
    - An `array` just throws an error, since it can't be obviously converted to something.
- The object identifier and matching, ordering, and substring rules come from the `Attribute`
  - If the `Attribute` does not have matching, ordering, or substring rules,
    sensible defaults are used.
- For some reason, either OpenLDAP or phpLDAPAdmin fails with cryptic errors
  when line-folding is used in OLC schemata. For that reason, every schema item
  will only be on a single line, ugly though it makes the output.
  - I suspect that phpLDAPAdmin is stripping the line-folding whitespace, but
    I cannot confirm it. I also managed to cause errors by using horizontal
    tabs instead of spaces.
- I thought that OLC configuration would apply automatically, no matter the
  DN of the schema entries. As it turns out, nothing happens unless these
  entries are under `cn=schema,cn=config`.
- This library will only use a `Database` for uniting schema under a single
  `olcSchemaConfig` object named after the database.
- This library will not attempt to name attributes in a way to reduce
  collisions.
- You will be unable to index an attribute with, for example, an `eq` index
  if you did not define it with an `EQUALITY` matching rule.

## To Do

- [ ] Configurable database files location
- [ ] Configurable LDAP backend
- [x] Get `Entry` DN from `distinguishedName`
- [x] Restrict attribute names:
  - [x] `dn`
  - [x] `distinguishedName`
  - [x] `objectClass`
- [ ] Warn on unrecognized kinds
- [ ] Use backup syntax OIDs
- [ ] Use attribute aliases
- [ ] Add and use syntax rule OIDs
  - [ ] `EQUALITY`
  - [ ] `ORDERING`
  - [ ] `SUBSTR`
- [ ] Configure `Constraints` overlay.
- [ ] Configure `refint` overlay.
- [ ] Testing
  - [ ] Test every equality, ordering, and substring rule.

## Order of operations

1. Transpile `Preamble`
2. Transpile `DataBase`.
  1. Filter all `Struct`s, `Attribute`s, and `ForeignKeys` within that database.
  2. Transpile all `Attribute`s.
  3. Transpile all `ForeignKey`s.
  4. Transpile all `Struct`s.
3. Transpile `PlainIndex`.
4. Transpile `TextIndex`?
5. Transpile `Entry`.
6. Transpile `Postamble`.
